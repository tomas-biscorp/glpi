/*!
 * Protovis MSIE/VML addon
 * Copyright (C) 2011 by DataMarket <http://datamarket.com>
 * Dual licensed under the terms of the MIT or GPL Version 2 software licenses.
 * 
 * This software includes code from jQuery, http://jquery.com/
 * jQuery is licensed under the MIT or GPL Version 2 license.
 * 
 * This software includes code from the Protovis, http://mbostock.github.com/protovis/
 * Protovis is licensed under the BSD license.
 * 
 */// detect SVG support
pv.have_SVG=!(!document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect);pv.have_VML=function(f,m,n){m=f.createElement("div");m.innerHTML='<v:shape adj="1" />';n=m.firstChild;n.style.behavior="url(#default#VML)";return n?"object"===typeof n.adj:!0}(document);Array.prototype.indexOf||(Array.prototype.indexOf=function(f,m){for(var n=this.length>>>0,q=!isFinite(m)||0>m?0:m>this.length?this.length:m;q<n;q++)if(this[q]===f)return q;return-1});
!pv.have_SVG&&pv.have_VML&&function(){"function"!==typeof Date.now&&(Date.now=function(){return 1*new Date});var f={round:function(a){return Math.round(21.6*a)},styles:null,pre:"<v:",post:' class="msvml">',block:{group:1,shape:1,shapetype:1,line:1,polyline:1,curve:1,rect:1,roundrect:1,oval:1,arc:1,image:1},ends:{butt:"flat",round:"round",square:"square",flat:"flat"},joins:{bevel:"bevel",round:"round",miter:"miter"},cursorstyles:{hand:"pointer",crosshair:1,pointer:1,move:1,text:1,wait:1,help:1,progress:1,
"n-resize":1,"ne-resize":1,"nw-resize":1,"s-resize":1,"se-resize":1,"sw-resize":1,"e-resize":1,"w-resize":1},text_shim:null,_textcache:{},text_dims:function(a,b){b in f._textcache||(f._textcache[b]={});if(a in f._textcache[b])return f._textcache[b][a];var c=f.text_shim;c.style.font=b;c.innerText=a;return f._textcache[b][a]={fontsize:parseInt(c.style.fontSize,10),height:c.offsetHeight,width:c.offsetWidth}},d2r:2*Math.PI/360,get_dim:function(a,b){var c=b||{};c.translate_x=0;c.translate_y=0;if(a.transform){var d=
/translate\((\d+(?:\.\d+)?)(?:,(\d+(?:\.\d+)?))?\)/.exec(a.transform);d&&d[1]&&(c.translate_x=parseFloat(d[1]));d&&d[2]&&(c.translate_y=parseFloat(d[2]));if(d=/rotate\((-?\d+\.\d+|-?\d+)\)/.exec(a.transform))c.rotation=parseFloat(d[1])%360}c.x=parseFloat(a.x||0);c.y=parseFloat(a.y||0);"width"in a&&(c.width=parseInt(a.width,10));"height"in a&&(c.height=parseInt(a.height,10));return c},elm_defaults:{g:{rewrite:"span",attr:function(a,b,c){a=f.get_dim(a);c.style.cssText="position:absolute;zoom:1;left:"+
(a.translate_x+a.x)+"px;top:"+(a.translate_y+a.y)+"px;"}},line:{rewrite:"shape",attr:function(a,b,c){var b=parseFloat(a.x1||0),d=parseFloat(a.y1||0),e=parseFloat(a.x2||0),i=parseFloat(a.y2||0),h=f.round;c.coordorigin="0,0";c.coordsize="21600,21600";f.path(c).v="M "+h(b)+" "+h(d)+" L "+h(e)+" "+h(i)+" E";f.stroke(c,a)},css:"top:0px;left:0px;width:1000px;height:1000px"},rect:{rewrite:"shape",attr:function(a,b,c){var d=f.get_dim(a),b=f.path(c),e=f.round;c.coordorigin="0,0";c.coordsize="21600,21600";
var i=e(d.translate_x+d.x),h=e(d.translate_y+d.y),k=e(d.width),d=e(d.height);b.v="M "+i+" "+h+" L "+(i+k)+" "+h+" L "+(i+k)+" "+(h+d)+" L "+i+" "+(h+d)+" x";f.stroke(c,a);f.fill(c,a)},css:"top:0px;left:0px;width:1000px;height:1000px"},path:{rewrite:"shape",attr:function(a,b,c){var b=f.get_dim(a),d=c.style;d.left=b.translate_x+b.x+"px";d.top=b.translate_y+b.y+"px";c.coordorigin="0,0";c.coordsize="21600,21600";f.path(c,a.d);f.fill(c,a);f.stroke(c,a);b.rotation?(b=~~b.rotation%360*f.d2r,a=Math.cos(b),
b=Math.sin(b),f.skew(c,[a.toFixed(8),-b.toFixed(8),b.toFixed(8),a.toFixed(8),0,0].join())):f.skew(c,"")},css:"top:0px;left:0px;width:1000px;height:1000px"},circle:{rewrite:"oval",attr:function(a,b,c){var b=f.get_dim(a),d=c.style,e=parseFloat(a.cx||0)+0.7,i=parseFloat(a.cy||0)+0.7,h=parseFloat(a.r||0)+0.5;d.top=b.translate_y+i-h+"px";d.left=b.translate_x+e-h+"px";d.width=2*h+"px";d.height=2*h+"px";f.fill(c,a);f.stroke(c,a)}},text:{rewrite:"span"},svg:{rewrite:"span",css:"position:relative;overflow:hidden;display:inline-block;~display:block;"},
"vml:textpath":{rewrite:"textpath"},"vml:skew":{rewrite:"skew"},"vml:path":{rewrite:"path"},"vml:stroke":{rewrite:"stroke"},"vml:fill":{rewrite:"fill"}},_elmcache:{span:document.createElement("span"),div:document.createElement("div")},_elementZIndex:1,createElement:function(a){var b;b=f._elmcache;var c=f.elm_defaults[a]||{},a=c.rewrite||a;a in b||(b[a]=document.createElement(f.pre+a+f.post),a in f.block&&(b[a].className+=" msvml_block"));b=b[a].cloneNode(!1);c.css&&(b.style.cssText=c.css);a in f.block&&
(b.style.cssText=b.style.cssText?b.style.cssText+(";z-index:"+f._elementZIndex++):"z-index:"+f._elementZIndex++);return b},_hex:pv.range(0,256).map(function(a){return pv.Format.pad("0",2,a.toString(16))}),_colorcache:{none:"transparent"},color:function(a,b){if(!(a in f._colorcache)&&(b=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(a)))f._colorcache[a]="#"+f._hex[b[1]]+f._hex[b[2]]+f._hex[b[3]];return f._colorcache[a]||a},fill:function(a,b){var c=a.getElementsByTagName("fill")[0];c||(c=a.appendChild(f.createElement("vml:fill")));
!b.fill||"none"===b.fill?c.on=!1:(c.on="true",c.color=f.color(b.fill),c.opacity=parseFloat(b["fill-opacity"]||"1")||"1")},stroke:function(a,b){var c=a.getElementsByTagName("stroke")[0];c||(c=a.appendChild(f.createElement("vml:stroke")));!b.stroke||"none"===b.stroke?(c.on="false",c.weight="0"):(c.on="true",c.weight=parseFloat(b["stroke-width"]||"1")/1.25,c.color=f.color(b.stroke)||"black",c.opacity=parseFloat(b["stroke-opacity"]||"1")||"1",c.joinstyle=f.joins[b["stroke-linejoin"]]||"miter",c.dashstyle=
b["stroke-dasharray"]||"")},path:function(a,b){var c=a.getElementsByTagName("path")[0];c||(c=a.appendChild(f.createElement("vml:path")));1<arguments.length&&(c.v=f.rewritePath(b));return c},skew:function(a,b){var c=a.getElementsByTagName("skew")[0];c||(c=a.appendChild(f.createElement("vml:skew")),c.origin="-0.5 -0.5",c.on=!0);1<arguments.length&&c.setAttribute("matrix",b);return c},init:function(){f.text_shim||(f.text_shim=document.getElementById("pv_vml_text_shim")||document.createElement("span"),
f.text_shim.id="protovisvml_text_shim",f.text_shim.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline-block;white-space:nowrap;",document.body.insertBefore(f.text_shim,document.body.firstChild));if(!f.styles){f.styles=document.getElementById("protovisvml_styles")||document.createElement("style");"protovisvml_styles"!==f.styles.id&&(f.styles.id="protovisvml_styles",document.documentElement.firstChild.appendChild(f.styles),f.styles.styleSheet.addRule(".msvml",
"behavior:url(#default#VML);"),f.styles.styleSheet.addRule(".msvml_block","position:absolute;top:0;left:0;"));try{document.namespaces.v||document.namespaces.add("v","urn:schemas-microsoft-com:vml")}catch(a){f.pre="<",f.post=' class="msvml" xmlns="urn:schemas-microsoft.com:vml">'}}},_pathcache:{},rewritePath:function(a){var b=0,c=0,d=f.round;if(!a)return a;if(a in f._pathcache)return f._pathcache[a];for(var a=a.replace(/(\d*)((\.*\d*)(e ?-?\d*))/g,"$1"),e=a.match(/([MLHVCSQTAZ][^MLHVCSQTAZ]*)/gi),
i=[],h=[],k=0,l=e.length;k<l;k++){var g=e[k],j=g.charAt(0),g=g.substring(1).split(/[, ]/),p=0;switch(j){case "M":j="m";b=d(g[0]);c=d(g[1]);g=[b,c];break;case "m":j="m";b+=d(g[0]);c+=d(g[1]);g=[b,c];break;case "A":j="l";g=[b=d(g[5]),c=d(g[6])];break;case "L":for(j="";p<g.length;)i.push("l",(b=d(g[p++]))+","+(c=d(g[p++])));break;case "l":for(j="";p<g.length;)i.push("l",(b+=d(g[p++]))+","+(c+=d(g[p++])));break;case "H":j="l";g=[b=d(g[0]),c];break;case "h":j="l";g=[b+=d(g[0]),c];break;case "V":j="l";
g=[b,c=d(g[0])];break;case "v":j="l";g=[b,c+=d(g[0])];break;case "C":j="c";h=g=[d(g[0]),d(g[1]),d(g[2]),d(g[3]),b=d(g[4]),c=d(g[5])];break;case "c":j="c";h=g=[b+d(g[0]),c+d(g[1]),b+d(g[2]),c+d(g[3]),b+=d(g[4]),c+=d(g[5])];break;case "S":j="c";h=g=[h[4]+(h[4]-h[2]),h[5]+(h[5]-h[3]),d(g[0]),d(g[1]),b=d(g[2]),c=d(g[3])];break;case "s":j="c";h=g=[h[4]+(h[4]-h[2]),h[5]+(h[5]-h[3]),b+d(g[0]),c+d(g[1]),b+=d(g[2]),c+=d(g[3])];break;case "Q":var j="c",p=d(g[0]),m=d(g[1]),n=d(g[2]),g=d(g[3]),g=[~~(b+2*(p-b)/
3),~~(c+2*(m-c)/3),~~(p+(n-p)/3),~~(m+(g-m)/3),b=n,c=g];break;case "q":j="l";b+=d(g[2]);c+=d(g[3]);g=[b,c];break;case "Z":case "z":j="xe";g=[];break;default:j="",g=[]}j&&i.push(j,g.join(","))}return f._pathcache[a]=i.join("")+"e"}};pv.VmlScene={scale:1,events:"mousewheel mousedown mouseup mouseover mouseout mousemove click dblclick".split(" "),implicit:{css:{}},copy_functions:function(a){for(var b in a)"function"===typeof a[b]&&!(b in pv.VmlScene)&&(pv.VmlScene[b]=a[b])}};pv.VmlScene.copy_functions(pv.SvgScene);
pv.Scene=pv.VmlScene;pv.VmlScene.expect=function(a,b,c,d){var d=d||{},e=f.elm_defaults[b]||{},i=e.rewrite||b;a?a.tagName.toUpperCase()!==i.toUpperCase()&&(b=f.createElement(b),a.parentNode.replaceChild(b,a),a=b):a=f.createElement(b);"attr"in e&&e.attr(c,d,a);c.cursor in f.cursorstyles&&(e=f.cursorstyles[c.cursor],d.cursor=1===e?c.cursor:e);for(var h in d)c=d[h],null==c?a.style.removeAttribute(h):a.style[h]=c;return a};pv.VmlScene.append=function(a,b,c){a.$scene={scenes:b,index:c};a=this.title(a,b[c]);
(!a.parentNode||11===a.parentNode.nodeType)&&b.$g.appendChild(a);return a.nextSibling};pv.VmlScene.title=function(a,b){a.title=b.title||"";return a};pv.VmlScene.panel=function(a){for(var b=a.$g,c=b&&b.firstChild,d=0;d<a.length;d++){var e=a[d];if(e.visible){if(!a.parent){e.canvas.style.display="inline-block";e.canvas.style.zoom=1;b&&b.parentNode!=e.canvas&&(c=(b=e.canvas.firstChild)&&b.firstChild);if(!b){f.init();for(var b=e.canvas.appendChild(f.createElement("svg")),i=0;i<this.events.length;i++)b.addEventListener?
b.addEventListener(this.events[i],this.dispatch,!1):b.attachEvent("on"+this.events[i],this.dispatch);c=b.firstChild}a.$g=b;var i=e.width+e.left+e.right,h=e.height+e.top+e.bottom;b.style.width=i+"px";b.style.height=h+"px";b.style.clip="rect(0px "+i+"px "+h+"px 0px)"}var c=this.fill(c,a,d),h=this.scale,k=e.transform,l=e.left+k.x,g=e.top+k.y;this.scale*=k.k;for(i=0;i<e.children.length;i++){e.children[i].$g=c=this.expect(c,"g",{transform:"translate("+l+","+g+")"+(1!=k.k?" scale("+k.k+")":"")});this.updateAll(e.children[i]);
if(!c.parentNode||11===c.parentNode.nodeType){b.appendChild(c);var j=f.elm_defaults[c.svgtype];if(j&&"function"===typeof j.onappend)j.onappend(c,a[d])}c=c.nextSibling}this.scale=h;c=this.stroke(c,a,d)}}return c};pv.VmlScene.fill=function(a,b,c){var d=b[c],e=d.fillStyle;if(e.opacity||"all"==d.events)a=this.expect(a,"div",{},{cursor:d.cursor,left:d.left,top:d.top,width:d.width,height:d.height,border:"none",background:f.color(e.color),position:"absolute"}),a=this.append(a,b,c);return a};pv.VmlScene.stroke=
function(a,b,c){var d=b[c],e=d.strokeStyle;if(e.opacity||"all"==d.events)var i=Math.round(d.lineWidth/this.scale),a=this.expect(a,"div",{},{cursor:d.cursor,left:d.left-i/2,top:d.top-i/2,width:Math.max(1E-10,d.width)-i,height:Math.max(1E-10,d.height)-i,border:i+"px solid "+f.color(e.color),zoom:1,position:"absolute"}),a=this.append(a,b,c);return a};var m=function(a){if(a&&a.type){if(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=q,a.defaultPrevented||!1===a.returnValue||a.getPreventDefault&&
a.getPreventDefault())this.isDefaultPrevented=n}else this.type=a;this.timeStamp=Date.now()},n=function(){return!0},q=function(){return!1},r="altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" ");m.prototype={preventDefault:function(){this.isDefaultPrevented=
n;var a=this.originalEvent;a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=n;var a=this.originalEvent;a&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=n;this.stopPropagation()},isDefaultPrevented:q,isPropagationStopped:q,isImmediatePropagationStopped:q};f.fixEvent=function(a){for(var b=a,a=new m(b),c=0,d=r.length;c<d;c++){var e=r[c];a[e]=b[e]}a.target||
(a.target=a.srcElement||document);!a.relatedTarget&&a.fromElement&&(a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement);null==a.pageX&&null!=a.clientX&&(b=document.documentElement,c=document.body,a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b&&b.clientLeft||c&&c.clientLeft||0),a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b&&b.clientTop||c&&c.clientTop||0));if(null==a.which&&(null!=a.charCode||null!=a.keyCode))a.which=null!=a.charCode?a.charCode:a.keyCode;!a.metaKey&&
a.ctrlKey&&(a.metaKey=a.ctrlKey);!a.which&&void 0!==a.button&&(a.which=a.button&1?1:a.button&2?3:a.button&4?2:0);"mousewheel"===a.type&&(a.wheel=a.wheelDelta);return a};pv.listener=function(a){return a.$listener||(a.$listener=function(b){try{return pv.event=f.fixEvent(b||window.event),a.call(this,pv.event)}catch(c){pv.error(c)}finally{delete pv.event}})};pv.listen=function(a,b,c){c=pv.listener(c,a);a===window&&(a=document.documentElement);return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+
b,c)};pv.VmlScene.dispatch=pv.listener(function(a){var b=a.target.$scene;b&&pv.Mark.dispatch(a.type,b.scenes,b.index)&&a.preventDefault()});pv.VmlScene.image=function(a){for(var b=a.$g.firstChild,c=0;c<a.length;c++){var d=a[c];if(d.visible){b=this.fill(b,a,c);if(!d.image){b=new Image;b.src=d.url;var e=b.style;e.position="absolute";e.top=d.top;e.left=d.left;e.width=d.width;e.height=d.height;e.cursor=d.cursor;e.msInterpolationMode="bicubic"}b=this.append(b,a,c);b=this.stroke(b,a,c)}}return b};pv.VmlScene.label=
function(a){for(var b=a.$g.firstChild,c=0;c<a.length;c++){var d=a[c];if(d.visible){var e=d.textStyle;if(e.opacity&&d.text){var i={};d.cursor&&(i.cursor=d.cursor);var h=d.text.replace(/\s+/g,"\u00a0"),k=f.text_dims(h,d.font),l=0,g=100,j=0,m="left";if(d.textAngle){if("top"===d.textBaseline?j+=d.textMargin+0.4*k.fontsize:"bottom"===d.textBaseline&&(j-=d.textMargin+0.33*k.fontsize),"center"===d.textAlign?(l=-k.width/2,g=k.width):"right"===d.textAlign?(l=-d.textMargin,g=-(d.textMargin+k.width),m="right"):
"left"===d.textAlign&&(l=d.textMargin,g=d.textMargin+k.width),b=this.expect(b,"path",{"pointer-events":d.events,cursor:d.cursor,transform:"translate("+d.left+","+d.top+")"+(d.textAngle?" rotate("+180*d.textAngle/Math.PI+")":""),d:"M"+l+","+j+" L"+g+","+j+" Z",fill:e.color,"fill-rule":"evenodd","fill-opacity":e.opacity||null}),e=b.getElementsByTagName("path")[0])e.textpathok=!0,e=b.getElementsByTagName("textpath")[0],e||(e=document.createElement(f.pre+"textpath"+f.post),b.appendChild(e),e.on=!0,e.style["v-text-kern"]=
!0),e.string=h,e.style.font=d.font,e.style["v-text-align"]=m}else"middle"===d.textBaseline?j-=k.fontsize/2:"top"===d.textBaseline?j+=d.textMargin:"bottom"===d.textBaseline&&(j-=d.textMargin+k.fontsize),"center"===d.textAlign?l-=k.width/2:"right"===d.textAlign?l-=k.width+d.textMargin:"left"===d.textAlign&&(l+=d.textMargin),b=this.expect(b,"text",i,{font:d.font,textDecoration:d.textDecoration,top:Math.round(d.top+j)+"px",left:Math.round(d.left+l)+"px",position:"absolute",display:"block",lineHeight:1,
whiteSpace:"nowrap",zoom:1,cursor:"default",color:f.color(e.color)||"black"}),b.innerText=h;b=this.append(b,a,c)}}}return b};pv.VmlScene.wedge=function(a){for(var b=a.$g.firstChild,c=f.round,d=0;d<a.length;d++){var e=a[d];if(e.visible){var i=e.fillStyle,h=e.strokeStyle;if(i.opacity||h.opacity){b=this.expect(b,"path",{"pointer-events":e.events,cursor:e.cursor,transform:"translate("+e.left+","+e.top+")",d:"",fill:i.color,"fill-rule":"evenodd","fill-opacity":i.opacity||null,stroke:h.color,"stroke-opacity":h.opacity||
null,"stroke-width":h.opacity?e.lineWidth/this.scale:null});i=b.getElementsByTagName("path")[0];i||(i=f.make("path"),b.appendChild(i));var h=c(e.innerRadius),k=c(e.outerRadius);if(e.angle>=2*Math.PI)e=h?"AE0,0 "+k+","+k+" 0 23592960AL0,0 "+h+","+h+" 0 23592960":"AE0,0 "+k+","+k+" 0 23592960";else var l=Math.round(11796480*(e.startAngle/Math.PI)),e=Math.round(11796480*(e.angle/Math.PI)),e=h?"AE 0,0 "+k+","+k+" "+-l+" "+-e+" 0,0 "+h+","+h+" "+-(l+e)+" "+e+"X":"M0,0AE0,0 "+k+","+k+" "+-l+" "+-e+"X";
i.v=e;b=this.append(b,a,d)}}}return b}}();